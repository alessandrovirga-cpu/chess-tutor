<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Editor Grafico Scacchi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chessboard-1.0.0.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chessboard-1.0.0.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chess.js') }}"></script>
    
    <style>
        .editor-container {
            width: 100%;
            max-width: 900px;        /* Limite massimo per Desktop */
            margin: 20px auto;
            display: flex;
            flex-direction: column;  /* DEFAULT: Mobile First (uno sopra l'altro) */
            gap: 20px;
            padding: 10px;
            box-sizing: border-box;
        }

        .board-section { 
            width: 100%;             /* La scacchiera si adatta alla larghezza del telefono */
            max-width: 450px;        /* Non diventare gigante su desktop */
            margin: 0 auto;          /* Centra la scacchiera */
        }
        
        .controls-section { 
            width: 100%;             /* I controlli occupano tutta la larghezza */
        }

        /* MEDIA QUERY: Regole che scattano solo su schermi piÃ¹ grandi di 768px (Tablet/PC) */
        @media (min-width: 768px) {
            .editor-container {
                flex-direction: row; /* Rimetti affiancati su schermi grandi */
            }
            .controls-section {
                flex: 1;             /* Prendi lo spazio rimanente */
            }
        }

        /* Stili Generali */
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="text"], textarea { width: 100%; box-sizing: border-box; padding: 10px; font-size: 16px; }
        textarea { height: 80px; }
        
        .btn { margin-top: 10px; padding: 12px; width: 100%; cursor: pointer; font-size: 16px; border-radius: 5px; }
        .btn-primary { background-color: #4CAF50; color: white; border: none; font-weight: bold; }
        .btn-danger { background-color: #f44336; color: white; border: none; }
        .btn-secondary { background-color: #e7e7e7; border: 1px solid #ccc; }

        .phase-indicator {
            padding: 15px;
            margin-bottom: 15px;
            background-color: #e3f2fd;
            border-left: 5px solid #2196F3;
            font-size: 14px;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Crea Problema</h1>
    
    <form id="problemForm" method="POST" action="{{ url_for('new_problem_graphical') }}">
        <div class="editor-container">
            
            <div class="board-section">
                <div id="msgPhase1" class="phase-indicator">
                    <strong>Fase 1: Setup</strong><br>Trascina i pezzi per creare la posizione iniziale.
                </div>
                <div id="msgPhase2" class="phase-indicator hidden" style="background-color: #e8f5e9; border-color: #4CAF50;">
                    <strong>Fase 2: Registrazione</strong><br>Muovi i pezzi sulla scacchiera per registrare la soluzione.
                </div>

                <div id="board" style="width: 100%"></div>
                
                <div id="controlsPhase1">
                    <button type="button" class="btn btn-secondary" id="clearBtn">Svuota Scacchiera</button>
                    <button type="button" class="btn btn-secondary" id="startBtn">Posizione Iniziale</button>
                    <br><br>
                    <label>Chi muove per primo?</label>
                    <input type="radio" id="moveWhite" name="turn" value="w" checked> Bianco
                    <input type="radio" id="moveBlack" name="turn" value="b"> Nero
                    <br>
                    <button type="button" class="btn btn-primary" id="btnGoToRecord">âœ… Conferma Posizione & Registra Mosse</button>
                </div>

                <div id="controlsPhase2" class="hidden">
                    <button type="button" class="btn btn-danger" id="btnBackToSetup">â¬… Modifica Posizione Iniziale</button>
                    <button type="button" class="btn btn-secondary" id="btnUndoMove">Annulla Ultima Mossa</button>
                </div>
            </div>

            <div class="controls-section">
                
                <label for="solution">Soluzione Registrata:</label>
                <input type="text" id="solution" name="solution" required readonly 
                       placeholder="Fai le mosse sulla scacchiera..." style="background-color: #f9f9f9;">
                
                <label for="tags">Tags:</label>
                <textarea id="tags" name="tags" placeholder="Es: Matto in 2, Forchetta..."></textarea>

                <input type="hidden" id="fen" name="fen">



                <hr>
                <details>
                    <summary style="cursor:pointer; font-weight:bold; color:#555;">Dati Storici Partita (Opzionale)</summary>
                    <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;">
                        
                        <label>Giocatori:</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" name="white_player" placeholder="Bianco (es. Fischer)">
                            <input type="text" name="black_player" placeholder="Nero (es. Spassky)">
                        </div>

                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <label>Anno:</label>
                                <input type="number" name="game_year" placeholder="1972" min="1500" max="2099">
                            </div>
                            <div style="flex:1;">
                                <label>Vincitore:</label>
                                <select name="winner" style="width:100%; padding:10px; margin-top:5px;">
                                    <option value="">-- Seleziona --</option>
                                    <option value="0">Bianco (0)</option>
                                    <option value="1">Nero (1)</option>
                                </select>
                            </div>
                                <label>Lista / Categoria:</label>
                                <input type="text" name="custom_list" placeholder="Es. Capablanca, Finali di Torre..." list="existing-lists">
                                <datalist id="existing-lists">
                        </div>

                        <label>Torneo:</label>
                        <input type="text" name="tournament" placeholder="Campionato del Mondo">
                        </datalist>
                    </div>
                </details>
                <hr>
                <button type="submit" class="btn btn-primary" id="saveBtn" disabled>ðŸ’¾ Salva Problema nel DB</button>
                <br>
                <a href="{{ url_for('index') }}" style="display:block; text-align:center; margin-top:10px;">Annulla</a>
            </div>
        </div>
    </form>

    <script>
        // --- VARIABILI GLOBALI ---
        var board = null;
        var game = new Chess(); // Motore logico per la validazione
        var recordedMoves = []; // Lista delle mosse registrate
        var startFen = "";      // FEN della posizione iniziale (congelata)
        
        // Configurazione per le immagini
        var pieceThemePath = '{{ url_for("static", filename="img/chesspieces/wikipedia/") }}' + '{piece}.png';

        // --- INIZIALIZZAZIONE FASE 1: EDITOR ---
        function initSetupBoard() {
            var config = {
                draggable: true,
                dropOffBoard: 'trash',
                sparePieces: true,
                position: 'start',
                pieceTheme: pieceThemePath
            };
            board = Chessboard('board', config);
        }

        // Avviamo con l'editor
        initSetupBoard();

        // Pulsanti Setup
        $('#clearBtn').on('click', board.clear);
        $('#startBtn').on('click', board.start);


        // --- TRANSIZIONE: DA SETUP A REGISTRAZIONE ---
        $('#btnGoToRecord').on('click', function() {
            // 1. Catturiamo la posizione attuale e il turno
            var positionObj = board.position();
            var turn = $('input[name="turn"]:checked').val();
            
            // Convertiamo la posizione grafica in FEN parziale
            var positionFen = board.fen(); 
            
            // Costruiamo un FEN completo per chess.js
            // CORRETTO: Aggiunto spazio prima di KQkq
            var candidateFen = positionFen + " " + turn + " KQkq - 0 1"; 
            
            // 2. VALIDAZIONE CON CHESS.JS
            var validationResult = game.load(candidateFen);
            
            if (!validationResult) {
                alert("ERRORE: La posizione non Ã¨ valida!\n\nVerifica che:\n1. Ci siano sia il Re Bianco che il Re Nero.\n2. Non ci siano pedoni nell'ultima traversa.");
                return; 
            }

            if (game.in_checkmate()) {
                alert("Attenzione: In questa posizione Ã¨ giÃ  Scacco Matto!");
            }

            // 3. SE VALIDO: Blocchiamo la posizione iniziale
            startFen = candidateFen;
            $('#fen').val(startFen); 
            
            // 4. Passiamo alla Fase 2 (Grafica e Logica)
            enterRecordingMode();
        });


        // --- FASE 2: REGISTRAZIONE MOSSE ---
        function enterRecordingMode() {
            $('#controlsPhase1').addClass('hidden');
            $('#msgPhase1').addClass('hidden');
            $('#controlsPhase2').removeClass('hidden');
            $('#msgPhase2').removeClass('hidden');
            
            board.destroy(); 
            
            var config = {
                draggable: true,
                position: startFen,
                onDragStart: onDragStart, 
                onDrop: onDrop,           
                pieceTheme: pieceThemePath
            };
            board = Chessboard('board', config);
            
            recordedMoves = [];
            updateSolutionInput();
        }

        function onDragStart (source, piece, position, orientation) {
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop (source, target) {
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' 
            });

            if (move === null) return 'snapback';

            recordedMoves.push(move.san); 
            updateSolutionInput();
        }

        function updateSolutionInput() {
            $('#solution').val(recordedMoves.join(', '));
            
            if (recordedMoves.length > 0) {
                $('#saveBtn').prop('disabled', false);
            } else {
                $('#saveBtn').prop('disabled', true);
            }
        }

        // --- PULSANTI FASE 2 ---
        
        $('#btnBackToSetup').on('click', function() {
            game.reset();
            recordedMoves = [];
            updateSolutionInput();
            
            $('#controlsPhase2').addClass('hidden');
            $('#msgPhase2').addClass('hidden');
            $('#controlsPhase1').removeClass('hidden');
            $('#msgPhase1').removeClass('hidden');
            
            board.destroy();
            initSetupBoard();
            if(startFen) board.position(startFen.split(' ')[0]); 
        });

        $('#btnUndoMove').on('click', function() {
            var move = game.undo();
            if (move) {
                recordedMoves.pop();
                updateSolutionInput();
                board.position(game.fen());
            }
        });

        // RIDIMENSIONAMENTO AUTOMATICO
        $(window).resize(board.resize);
    </script>
</body>
</html>