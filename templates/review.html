<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Revisione Problema ID: {{ problem.id }}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chessboard-1.0.0.css') }}">
    
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chessboard-1.0.0.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chess.js') }}"></script>
    
    <style>
        /* Responsive Container */
        .board-container {
            width: 100%;
            max-width: 450px; 
            margin: 20px auto;
            padding: 0 10px;
            box-sizing: border-box;
            text-align: center; 
        }
        
        /* Stili Bottoni */
        button {
            padding: 12px;
            font-size: 16px;
            margin-top: 8px;
            width: 100%;
            touch-action: manipulation;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            color: white;
            font-weight: bold;
        }

        /* Colori Bottoni */
        #solveButton { background-color: #FF9800; color: white; } /* Arancione */
        #resetButton { background-color: #607D8B; color: white; } /* Grigio Blu */
        
        /* Bottoni Valutazione */
        #rateWrongButton { background-color: #f44336; } /* Rosso */
        #rateCorrectButton { background-color: #FFC107; color: black; } /* Giallo/Arancio */
        #rateMediumButton { background-color: #2196F3; } /* Blu */
        #rateEasyButton { background-color: #4CAF50; } /* Verde */

        .rating-container {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .rating-container button {
            flex: 1; 
            font-size: 14px;
        }

        .hidden { display: none !important; }

        /* Box Dati Storici */
        .history-box {
            background-color: #e3f2fd; 
            padding: 10px; 
            border-radius: 5px; 
            margin-bottom: 15px;
            border-left: 5px solid #2196F3;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="board-container">
        <h3>Problema #{{ problem.id }}</h3>

        {% if problem.white_player and problem.black_player %}
            <div class="history-box">
                <span style="font-size: 1.1em;">
                    ‚ö™ <strong>{{ problem.white_player }}</strong> vs ‚ö´ <strong>{{ problem.black_player }}</strong>
                </span>
                <br>
                <small style="color: #555;">
                    üìÖ {{ problem.game_year if problem.game_year else 'Anno sconosciuto' }} 
                    {% if problem.tournament %} - üèÜ {{ problem.tournament }} {% endif %}
                </small>
                <br>
                <small style="font-weight: bold; color: #333;">
                    Risultato: 
                    {% if problem.winner == 0 %} 1-0 (Vince il Bianco)
                    {% elif problem.winner == 1 %} 0-1 (Vince il Nero)
                    {% else %} ¬Ω-¬Ω o Sconosciuto {% endif %}
                </small>
            </div>
        {% else %}
            <p><small>Tags: {{ problem.tags|join(', ') }}</small></p>
        {% endif %}

        <div id="board" style="width: 100%"></div>

        <p id="status-message" style="font-weight: bold; margin: 15px 0;">
            Tocca a {{ 'Bianco' if problem.fen.split()[1] == 'w' else 'Nero' }} muovere.
        </p>

        <button id="solveButton">üëÅÔ∏è Vedi Risultato (Mi arrendo)</button>
        <button id="resetButton" class="hidden">üîÑ Riprova il problema</button>

        <hr>

        <div id="ratingSection">
            <p>Valuta la tua risposta:</p>
            <form id="ratingForm" method="POST" action="{{ url_for('rate_problem', problem_id=problem.id) }}">
                <div class="rating-container">
                    <button type="submit" name="rating" value="Sbagliato" id="rateWrongButton">Sbagliato</button>
                    <button type="submit" name="rating" value="Difficile" id="rateCorrectButton">Difficile</button>
                    <button type="submit" name="rating" value="Medio" id="rateMediumButton">Medio</button>
                    <button type="submit" name="rating" value="Facile" id="rateEasyButton">Facile</button>
                </div>
            </form>
        </div>

        <p><a href="{{ url_for('index') }}" style="display:block; margin-top:20px; color:#555;">Torna alla Dashboard</a></p>
    </div>

    <script>
        var problemFEN = "{{ problem.fen }}";
        var solutionMoves = {{ problem.solution_moves|tojson }}; 
        
        if (typeof Chess === 'undefined') {
            alert("Errore critico: chess.js non caricato.");
        }

        var game = new Chess();
        var loadResult = game.load(problemFEN);

        if (!loadResult) {
            $('#status-message').html('<strong style="color: red;">ERRORE FEN: Dati corrotti.</strong>');
        }

        var board = null;
        var currentMoveIndex = 0;
        var isSolving = true;
        
        // --- GESTIONE MOSSA UTENTE ---
        function onDrop (source, target) {
            if (!isSolving) return 'snapback'; 
            
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback'; 

            var correctMove = solutionMoves[currentMoveIndex];
            
            if (move.san === correctMove) {
                currentMoveIndex++; 
                updateStatus();     
                
                if (currentMoveIndex >= solutionMoves.length) {
                    puzzleSolved();
                } else {
                    setTimeout(makeComputerMove, 500);
                }
                
            } else {
                game.undo(); 
                $('#status-message').html('<span style="color: red;">‚ùå Mossa errata! Riprova.</span>');
                return 'snapback'; 
            }
        };

        // --- RISPOSTA AUTOMATICA DEL COMPUTER ---
        function makeComputerMove() {
            if (currentMoveIndex >= solutionMoves.length) return;

            var nextMoveSan = solutionMoves[currentMoveIndex];
            game.move(nextMoveSan);
            board.position(game.fen());

            currentMoveIndex++;
            updateStatus();
        
            if (currentMoveIndex >= solutionMoves.length) {
                puzzleSolved();
            }
        }

        // --- PUZZLE RISOLTO ---
        function puzzleSolved() {
            $('#status-message').html('<span style="color: green;">‚úÖ <strong>Risolto!</strong> Valuta la difficolt√†:</span>');
            isSolving = false; 
            $('#rateWrongButton').prop('disabled', true).css('opacity', '0.5'); 
            $('#solveButton').addClass('hidden'); 
        }

        // --- "VEDI RISULTATO" (Arresa) ---
        $('#solveButton').on('click', function() {
            isSolving = false; 
            
            // Nascondi pulsanti successo e tasto arrendi
            $('#rateCorrectButton, #rateMediumButton, #rateEasyButton').addClass('hidden');
            $('#solveButton').addClass('hidden');
            $('#resetButton').removeClass('hidden');

            // Trasforma "Sbagliato" in "Continua"
            $('#rateWrongButton')
                .text("Continua (Registra come Errore)")
                .css('width', '100%')
                .removeClass('hidden');

            $('#status-message').html('<strong>üëÄ Mostro la soluzione...</strong>');

            playSolutionAnimation();
        });

        // Animazione ricorsiva
        function playSolutionAnimation() {
            if (currentMoveIndex < solutionMoves.length) {
                var nextMove = solutionMoves[currentMoveIndex];
                game.move(nextMove);
                board.position(game.fen());
                currentMoveIndex++;
                
                setTimeout(playSolutionAnimation, 800);
            } else {
                $('#status-message').html('Soluzione completata. <strong>Clicca Continua.</strong>');
            }
        }

        // --- RESET ---
        $('#resetButton').on('click', function() {
            game.load(problemFEN);
            board.position(problemFEN);
            currentMoveIndex = 0;
            isSolving = true;
            updateStatus();
            
            $('#solveButton').removeClass('hidden');
            $('#resetButton').addClass('hidden');
            $('#rateCorrectButton, #rateMediumButton, #rateEasyButton').removeClass('hidden');
            $('#rateWrongButton').text("Sbagliato").css('width', 'auto').prop('disabled', false).css('opacity', '1');
        });

        function updateStatus () {
            var moveColor = 'Bianco';
            if (game.turn() === 'b') { moveColor = 'Nero'; }
            var status = 'Tocca a ' + moveColor;
            $('#status-message').text(status);
        };

        // Configurazione Scacchiera
        var config = {
            draggable: true,
            position: problemFEN,
            onDrop: onDrop,
            sparePieces: false,
            // Importante per le immagini dei pezzi
            pieceTheme: '{{ url_for("static", filename="img/chesspieces/wikipedia/") }}' + '{piece}.png'
        };

        board = Chessboard('board', config);
        updateStatus();
        $(window).resize(board.resize);
    </script>
</body>
</html>