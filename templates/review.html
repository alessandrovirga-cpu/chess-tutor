<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Revisione Problema ID: {{ problem.id }}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chessboard-1.0.0.css') }}">
    
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    
    <script src="{{ url_for('static', filename='js/chessboard-1.0.0.js') }}"></script>
    
    <script src="{{ url_for('static', filename='js/chess.js') }}"></script>
    
    <style>
        /* Responsive Container */
        .board-container {
            width: 100%;             /* Occupa tutto lo spazio disponibile */
            max-width: 400px;        /* ...ma fermati a 400px su schermi grandi */
            margin: 20px auto;       /* Centra */
            padding: 0 10px;         /* Aggiungi un po' di respiro ai lati su mobile */
            box-sizing: border-box;  /* Include il padding nel calcolo della larghezza */
        }
        
        /* Rendiamo i bottoni più facili da premere col dito */
        button {
            padding: 12px;
            font-size: 16px;
            margin-top: 5px;
            width: 100%;
            touch-action: manipulation; /* Migliora la risposta al tocco */
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="board-container">
        <h1>Problema Scacchistico: {{ problem.id }}</h1>
        <p><strong>Tags:</strong> {{ problem.tags|join(', ') }}</p>

        <div id="board" style="width: 100%"></div>

        <p id="status-message">Tocca a {{ 'Bianco' if problem.fen.split()[1] == 'w' else 'Nero' }} muovere.</p>

        <button id="solveButton">Mostra Soluzione / Arrenditi</button>
        <button id="resetButton" style="display: none;">Riprova</button>

        <hr>

        <h2>Valuta la tua risposta:</h2>
        <form id="ratingForm" method="POST" action="{{ url_for('rate_problem', problem_id=problem.id) }}">
            <button type="submit" name="rating" value="Sbagliato" id="rateWrongButton">Sbagliato (0)</button>
            <button type="submit" name="rating" value="Difficile" id="rateCorrectButton">Difficile (3)</button>
            <button type="submit" name="rating" value="Medio" name="rating">Medio (4)</button>
            <button type="submit" name="rating" value="Facile" name="rating">Facile (5)</button>
        </form>

        <p><a href="{{ url_for('index') }}">Torna alla Dashboard</a></p>
    </div>

    <script>
        var problemFEN = "{{ problem.fen }}";
        var solutionMoves = {{ problem.solution_moves|tojson }}; 
        
        // Verifica se Chess è stato caricato correttamente
        if (typeof Chess === 'undefined') {
            alert("Errore critico: La libreria chess.js non è stata caricata. Controlla la connessione internet o il file locale.");
        }

        var game = new Chess();
        var loadResult = game.load(problemFEN);

        if (!loadResult) {
            $('#status-message').html('<strong style="color: red;">ERRORE FEN: Impossibile caricare la partita.</strong>');
        }

        var board = null;
        var currentMoveIndex = 0;
        var isSolving = true;
        
        function onDrop (source, target) {
            if (!isSolving) return 'snapback'; 
            
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback'; 

            var correctMove = solutionMoves[currentMoveIndex];
            
            if (move.san === correctMove) {
                currentMoveIndex++; 
                updateStatus();     
                
                if (currentMoveIndex >= solutionMoves.length) {
                    $('#status-message').html('<strong>Risolto!</strong> Ottimo lavoro. Valuta la difficoltà:');
                    isSolving = false; 
                    $('#rateWrongButton').prop('disabled', true); 
                } else {
                    setTimeout(makeComputerMove, 500);
                }
                
            } else {
                game.undo(); 
                $('#status-message').html('<span style="color: red;">Mossa errata! Riprova.</span>');
                return 'snapback'; 
            }
        };

        function makeComputerMove() {
            if (currentMoveIndex >= solutionMoves.length) return;

            var nextMoveSan = solutionMoves[currentMoveIndex];
            game.move(nextMoveSan);
            board.position(game.fen());

            currentMoveIndex++;
            updateStatus();
        
            if (currentMoveIndex >= solutionMoves.length) {
                $('#status-message').html('<strong>Risolto!</strong> (Sull\'ultima mossa avversaria).');
                isSolving = false;
                $('#rateWrongButton').prop('disabled', true);
            }
        }

        function updateStatus () {
            var moveColor = 'Bianco';
            if (game.turn() === 'b') {
                moveColor = 'Nero';
            }
            var status = 'Tocca a ' + moveColor + ' muovere.';
            if (currentMoveIndex > 0) {
                status += ' Mossa ' + (currentMoveIndex + 1) + ' di ' + solutionMoves.length + '.';
            }
            $('#status-message').html(status);
        };

        function resetProblem() {
            game.load(problemFEN);
            board.position(problemFEN);
            currentMoveIndex = 0;
            isSolving = true;
            updateStatus();
            $('#solveButton').show();
            $('#resetButton').hide();
            $('#ratingForm button').prop('disabled', false);
            $('#rateWrongButton').prop('disabled', false); 
        }

        $('#solveButton').on('click', function() {
            isSolving = false;
            $('#status-message').html('**Arreso/Soluzione Mostrata!** Premi Sbagliato e Riprova.');
            $('#solveButton').hide();
            $('#resetButton').show();
            $('#rateCorrectButton, #rateMediumButton, #rateEasyButton').prop('disabled', true); 
        });
        
        $('#resetButton').on('click', resetProblem);

        // CONFIGURAZIONE SCACCHIERA
        var config = {
            draggable: true,
            position: problemFEN,
            onDrop: onDrop,
            sparePieces: false,
            pieceTheme: '{{ url_for("static", filename="img/chesspieces/wikipedia/") }}' + '{piece}.png'
        };

        board = Chessboard('board', config);
        updateStatus();

        // RIDIMENSIONAMENTO AUTOMATICO
        $(window).resize(board.resize);
    </script>
</body>
</html>