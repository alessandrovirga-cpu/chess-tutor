<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Revisione Problema ID: {{ problem.id }}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chessboard-1.0.0.css') }}">
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chessboard-1.0.0.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    
    <style>
        /* Stile per centrare la scacchiera e definirne la dimensione massima */
        .board-container {
            width: 400px; /* Dimensioni tipiche per dispositivi mobili */
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <div class="board-container">
        <h1>Problema Scacchistico: {{ problem.id }}</h1>
        <p><strong>Tags:</strong> {{ problem.tags|join(', ') }}</p>

        <div id="board" style="width: 100%"></div>

        <p id="status-message">Tocca a {{ 'Bianco' if problem.fen.split()[1] == 'w' else 'Nero' }} muovere.</p>

        <button id="solveButton">Mostra Soluzione / Arrenditi</button>
        <button id="resetButton" style="display: none;">Riprova</button>

        <hr>

        <h2>Valuta la tua risposta:</h2>
        <form id="ratingForm" method="POST" action="{{ url_for('rate_problem', problem_id=problem.id) }}">
            <button type="submit" name="rating" value="Sbagliato" id="rateWrongButton">Sbagliato (0)</button>
            <button type="submit" name="rating" value="Difficile" id="rateCorrectButton">Difficile (3)</button>
            <button type="submit" name="rating" value="Medio" name="rating">Medio (4)</button>
            <button type="submit" name="rating" value="Facile" name="rating">Facile (5)</button>
        </form>

        <p><a href="{{ url_for('index') }}">Torna alla Dashboard</a></p>
    </div>

    <script>
        // Il FEN della posizione iniziale
        var problemFEN = "{{ problem.fen }}";
        // La soluzione (lista di mosse, es: ['Nf3', 'e5'])
        var solutionMoves = {{ problem.solution_moves|tojson }}; 
        
        // Inizializza la logica scacchistica
        var game = new Chess(problemFEN);
        // Inizializza la scacchiera grafica
        var board = null;

        // Indice della mossa che l'utente deve ancora fare
        var currentMoveIndex = 0;
        // La scacchiera è in modalità di risoluzione
        var isSolving = true;
        
        // Funzione per la gestione delle mosse dell'utente sulla scacchiera
        function onDrop (source, target) {
            if (!isSolving) {
                return 'snapback'; // Non permettere mosse se la soluzione è già stata mostrata
            }
            
            // Prova a creare la mossa (es. 'e2e4')
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // Assumiamo promozione a regina per semplicità
            });
            
            // mossa non legale
            if (move === null) return 'snapback'; 

            // Se la mossa è legale, controlla se è la mossa corretta della soluzione
            var correctMove = solutionMoves[currentMoveIndex];
            
            if (move.san === correctMove) { // SAN: Standard Algebraic Notation (es. Nf3)
                currentMoveIndex++;
                updateStatus();
                
                // Se tutte le mosse della soluzione sono state completate
                if (currentMoveIndex >= solutionMoves.length) {
                    $('#status-message').html('**Risolto!** Ora puoi valutare la tua performance.');
                    isSolving = false; // Blocca ulteriori mosse
                    $('#rateWrongButton').prop('disabled', true); // Non può essere 'Sbagliato' se ha risolto
                    return; // Mossa corretta, non c'è bisogno di snapback
                }
            } else {
                // Mossa legale ma ERRATA per la soluzione
                game.undo(); // Annulla la mossa
                $('#status-message').html('<span style="color: red;">Mossa errata. Riprova.</span>');
                return 'snapback'; // Riporta il pezzo alla posizione iniziale
            }
        };

        // Aggiorna lo stato della partita e i bottoni
        function updateStatus () {
            var moveColor = 'Bianco';
            if (game.turn() === 'b') {
                moveColor = 'Nero';
            }
            
            var status = 'Tocca a ' + moveColor + ' muovere.';
            if (currentMoveIndex > 0) {
                status += ' Mossa ' + (currentMoveIndex + 1) + ' di ' + solutionMoves.length + '.';
            }
            $('#status-message').html(status);
        };

        // Funzione per resettare il problema (per riprovare dopo aver visto la soluzione)
        function resetProblem() {
            game.load(problemFEN);
            board.position(problemFEN);
            currentMoveIndex = 0;
            isSolving = true;
            updateStatus();
            $('#solveButton').show();
            $('#resetButton').hide();
            $('#ratingForm button').prop('disabled', false);
            $('#rateWrongButton').prop('disabled', false); // Riabilita Sbagliato
        }

        // Gestione del pulsante "Mostra Soluzione / Arrenditi"
        $('#solveButton').on('click', function() {
            isSolving = false;
            $('#status-message').html('**Arreso/Soluzione Mostrata!** Premi Sbagliato e Riprova.');
            $('#solveButton').hide();
            $('#resetButton').show();
            
            // Simula il fallimento: Disabilita i pulsanti di successo
            $('#rateCorrectButton, #rateMediumButton, #rateEasyButton').prop('disabled', true); 
            
            // Se l'utente si arrende, deve premere Sbagliato (0) per resettare l'intervallo
            // Reindirizziamo l'utente a un passo indietro (undo)
            // L'utente deve inviare il form 'Sbagliato' manualmente.
        });
        
        $('#resetButton').on('click', resetProblem);

        // Configurazione della scacchiera
        var config = {
            draggable: true,
            position: problemFEN,
            onDrop: onDrop,
            sparePieces: false, // Non mostrare pezzi extra
            pieceTheme: '{{ url_for("static", filename="img/chesspieces/wikipedia/") }}' + '{piece}.png'
        };

        // Inizializza la scacchiera
        board = Chessboard('board', config);
        
        // Aggiorna lo stato iniziale
        updateStatus();
        
    </script>
</body>
</html>